#!/bin/bash

set -o errexit

DOCKER_TAG=$(echo $GITHUB_SHA | cut -c1-7)
DOCKER_FILE=Dockerfile.unified

DOCKER_IMAGE=$DOCKER_REGISTRY/$DOCKER_USERNAME/$DOCKER_REPOSITORY:$DOCKER_TAG

sed -i "s/WEBAPP_VERSION=.*/WEBAPP_VERSION=$DOCKER_TAG/g" $DOCKER_FILE

docker build -t $DOCKER_IMAGE -f $DOCKER_FILE .
docker push $DOCKER_IMAGE

exit 0
